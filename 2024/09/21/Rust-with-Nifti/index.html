<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Chengran Li">


    <meta name="subtitle" content="A blog about Cognitive Neuroscience, Programming and more.">






<title>Rust with Nifti | Single Neuron.</title>



    <link rel="icon" href="/favicon.ico">


<!-- Open Graph Meta Tags -->



<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Roboto+Mono&display=swap');
</style>



    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    
    <link rel="stylesheet" href="/css/layout.css">
    




    <!-- scripts list from _config.yml -->
    
    <script src="/js/menu.js"></script>
    
    <script src="/js/search.js"></script>
    










  <meta name="generator" content="Hexo 7.3.0"></head>
  <body>
    <div class="mask-border">
    </div>

    <div class="wrapper">

      <div class="header">
  <div class="flex-container">
    <div class="header-inner">
      <div class="site-brand-container">
        <a href="/">
          
            <img class="logo-img" src="/logo.png" alt="logo_image">
          
        </a>
      </div>
      <div id="menu-btn" class="menu-btn" onclick="toggleMenu()">
        Menu
      </div>
      <nav class="site-nav">
        <ul class="menu-list">
          
            
              <li class="menu-item">
                <a href="/">Home</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/categories/gallery/">Gallery</a>
              </li> 
                   
          
            
              <li class="menu-item">
                <a href="/subscribe/">Subscribe</a>
              </li> 
                   
          
          
            <li class="menu-item search-btn">
              <a href="#">Search</a>
            </li>
          
        </ul>
      </nav>
    </div>
  </div>
</div>


      <div class="main">
        <div class="flex-container">
          <article id="post">

  
    <div class="post-head">
    <div class="post-info">
        <div class="tag-list">
            
                
                    <span class="post-tag">
                        <a href="/tags/Rust/">
                            Rust
                        </a>
                    </span>    
                
                    <span class="post-tag">
                        <a href="/tags/Nifti/">
                            Nifti
                        </a>
                    </span>    
                
                    <span class="post-tag">
                        <a href="/tags/C/">
                            C
                        </a>
                    </span>    
                           
            
        </div>
        <div class="post-title">
            
            
                Rust with Nifti
            
            
        </div>
        <span class="post-date">
            Sep 21, 2024
        </span>
    </div>
    <div class="post-img">
        
            <img src="https://media.nga.gov/iiif/98dd3136-8113-4a69-a2b2-c7e5e855430a/full/full/0/default.jpg?attachment_filename=the_land-crab_%28cancer_ruricola%29_1991.163.46.jpg" alt="featured_image">
              
    </div>
</div>
    <div class="post-content">
    <h1 id="Working-with-NIFTI-C-library-in-Rust"><a href="#Working-with-NIFTI-C-library-in-Rust" class="headerlink" title="Working with NIFTI C library in Rust"></a>Working with NIFTI C library in Rust</h1><p>Rust offers excellent interoperability with C, and in this tutorial, I will introduce the file structure I use to compile the NIfTI C library with Rust. While there are some Rust crates that natively implement the NIfTI format, the NIfTI C library remains the gold standard for NIfTI format I&#x2F;O. It has been extensively tested and is widely used in a variety of fMRI visualization and analysis software. </p>
<h2 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h2><ul>
<li><strong>Cargo</strong>: Ensure Rust’s package manager is installed.</li>
<li><strong>C Compiler</strong>: Any distribution of a C compiler is needed.</li>
<li><strong>NIfTI C Library Code</strong>: The necessary code from the <a target="_blank" rel="noopener" href="https://github.com/NIFTI-Imaging/nifti_clib">NIfTI C library</a>, which includes the following files:<ul>
<li><code>nifti1.h</code></li>
<li><code>nifti2_io_version.h</code></li>
<li><code>nifti2_io.c</code></li>
<li><code>nifti2_io.h</code></li>
<li><code>nifti2.h</code></li>
<li><code>znzlib_version.h</code></li>
<li><code>znzlib.c</code></li>
<li><code>znzlib.h</code></li>
</ul>
</li>
</ul>
<h2 id="File-organizations"><a href="#File-organizations" class="headerlink" title="File organizations"></a>File organizations</h2><p>This is simply my preferred way of organizing the project, but you can structure it according to your own needs. Just make sure the paths are correctly set in the following sections, and everything should work as expected.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── Cargo.lock</span><br><span class="line">├── Cargo.toml</span><br><span class="line">├── README.md</span><br><span class="line">├── build.rs</span><br><span class="line">├── c_external</span><br><span class="line">│   ├── nifti1.h</span><br><span class="line">│   ├── nifti2.h</span><br><span class="line">│   ├── nifti2_io.c</span><br><span class="line">│   ├── nifti2_io.h</span><br><span class="line">│   ├── nifti2_io_version.h</span><br><span class="line">│   ├── znzlib.c</span><br><span class="line">│   ├── znzlib.h</span><br><span class="line">│   └── znzlib_version.h</span><br><span class="line">├── src</span><br><span class="line">    ├── main.rs</span><br><span class="line">    └── nifti</span><br><span class="line">        ├── mod.rs</span><br><span class="line">        ├── nifti.rs</span><br><span class="line">        └── nifti_io.rs</span><br></pre></td></tr></table></figure>



<h2 id="Tutorial"><a href="#Tutorial" class="headerlink" title="Tutorial"></a>Tutorial</h2><p>First, we need to create a rust project. We can do this by running the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo new nifti_rust</span><br></pre></td></tr></table></figure>

<p>Next, we need to move the NIfTI C library files to the <code>c_external</code> directory. Please download the NIfTI C library from the <a target="_blank" rel="noopener" href="https://github.com/NIFTI-Imaging/nifti_clib">official repository</a> and copy the files listed in the prerequisites section to the <code>c_external</code> directory.</p>
<p>We need a build script to compile the C code. Create a <code>build.rs</code> file in the root directory and add the following code:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    cc::Build::<span class="title function_ invoke__">new</span>()</span><br><span class="line">        .<span class="title function_ invoke__">file</span>(<span class="string">&quot;c_external/nifti2_io.c&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">file</span>(<span class="string">&quot;c_external/znzlib.c&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">include</span>(<span class="string">&quot;c_external&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">flag</span>(<span class="string">&quot;-Wno-unused-parameter&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">flag</span>(<span class="string">&quot;-Wno-unused-variable&quot;</span>)</span><br><span class="line">        .<span class="title function_ invoke__">compile</span>(<span class="string">&quot;nifti_c_lib&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The two flags are used to suppress warnings that are not relevant to the our rust project. We only need the nifti2_io.c and znzlib.c files to compile the NIfTI C library. The <code>include</code> method is used to specify the directory where the header files are located. The <code>compile</code> method is used to specify the name of the compiled library.</p>
<p>We also need to add the <code>cc</code> build dependency to the <code>Cargo.toml</code> file. Add the following line to the <code>Cargo.toml</code> file:</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[build-dependencies]</span></span><br><span class="line"><span class="attr">cc</span> = <span class="string">&quot;1.0&quot;</span></span><br></pre></td></tr></table></figure>

<p>Next, we need to create a module for the NIfTI C library. Create a <code>nifti</code> directory in the <code>src</code> directory. Inside the <code>nifti</code> directory, create a <code>mod.rs</code> file with the following code:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> nifti;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">mod</span> nifti_io;</span><br></pre></td></tr></table></figure>

<p>This will allow the <code>nifti</code> and <code>nifti_io</code> modules to be accessed from the <code>main.rs</code> file.<br>Because rust can not directly access C structs, we need to create rust structs that mirror the C structs. Create a <code>nifti.rs</code> file in the <code>nifti</code> directory. You can use AI to convert the C structs to Rust structs. A typical Rust struct with the same fields as the C struct would look like this:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#[repr(C)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">NiftiImage</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> ndim: <span class="type">i64</span>,              <span class="comment">// int64_t ndim;</span></span><br><span class="line">    <span class="keyword">pub</span> nx: <span class="type">i64</span>,                <span class="comment">// int64_t nx;</span></span><br><span class="line">    <span class="keyword">pub</span> ny: <span class="type">i64</span>,                <span class="comment">// int64_t ny;</span></span><br><span class="line">    <span class="keyword">pub</span> nz: <span class="type">i64</span>,                <span class="comment">// int64_t nz;</span></span><br><span class="line">    <span class="keyword">pub</span> nt: <span class="type">i64</span>,                <span class="comment">// int64_t nt;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Some structs may never be used directly in Rust, so you can skip them. The ‘#allow(dead_code)’ attribute can be used to suppress warnings about unused fields in the struct.</p>
<p>Now we can create a <code>nifti_io.rs</code> file in the <code>nifti</code> directory. This file will implement the IO functions in Rust with the help of the C library. The functions in the <code>nifti_io.rs</code> file will be used to read and write NIfTI files. </p>
<p>First we need the external crate to link the C library. Add the following line to the <code>nifti_io.rs</code> file:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="keyword">crate</span> libc;</span><br></pre></td></tr></table></figure>

<p>In order to use external crate in Rust, we need to add the crate to the <code>Cargo.toml</code> file. Add the following line to the <code>Cargo.toml</code> file:</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[dependencies]</span></span><br><span class="line"><span class="attr">libc</span> = <span class="string">&quot;0.2&quot;</span></span><br></pre></td></tr></table></figure>

<p>For converting the String to a C string, we need to use the <code>CString</code> type from the <code>std::ffi</code> module. Add the following line to the <code>nifti_io.rs</code> file:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::ffi::CString;</span><br></pre></td></tr></table></figure>

<p>And then we need to bring the struct we created in the <code>nifti.rs</code> file into the <code>nifti_io.rs</code> file. Add the following line to the <code>nifti_io.rs</code> file:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> super::nifti::NiftiImage;</span><br></pre></td></tr></table></figure>

<p>To access the C functions from the C library, we need to declare them as <code>extern</code> functions, for now just the read function. Add the following lines to the <code>nifti_io.rs</code> file:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">nifti_image_read</span>(filename: *<span class="keyword">const</span> libc::c_char) <span class="punctuation">-&gt;</span> *<span class="keyword">mut</span> NiftiImage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Next we can implement the read function in Rust. Add the following code to the <code>nifti_io.rs</code> file:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">read_nifti_image</span>(hname: &amp;<span class="type">str</span>, read_data: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">Box</span>&lt;NiftiImage&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">c_hname</span> = CString::<span class="title function_ invoke__">new</span>(hname).<span class="title function_ invoke__">expect</span>(<span class="string">&quot;CString::new failed&quot;</span>);</span><br><span class="line">    <span class="keyword">unsafe</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">image_ptr</span> = <span class="title function_ invoke__">nifti_image_read</span>(c_hname.<span class="title function_ invoke__">as_ptr</span>(), read_data);</span><br><span class="line">        <span class="keyword">if</span> image_ptr.<span class="title function_ invoke__">is_null</span>() &#123;</span><br><span class="line">            <span class="literal">None</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_ invoke__">Some</span>(<span class="type">Box</span>::<span class="title function_ invoke__">from_raw</span>(image_ptr))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>People use rust for its safty, however, when using C library, sometimes we can not avoid using unsafe code. The <code>nifti_image_read</code> function is declared as <code>unsafe</code> because it calls the <code>nifti_image_read</code> C function. We use the Box::from_raw function to convert the raw pointer to a Box, which will be handled by Rust’s memory management from now on. We kind of have to trust the C library to manage the memory correctly in the background. </p>
<p>Now we can test the read function in the <code>main.rs</code> file. Add the following code to the <code>main.rs</code> file:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mod</span> nifti;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">image</span> = nifti::nifti_io::<span class="title function_ invoke__">read_nifti_image</span>(<span class="string">&quot;test-cases/test.nii&quot;</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(image) = image &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Successfully read NIFTI image&quot;</span>);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;The dimensions are &#123;&#125;, &#123;&#125;, &#123;&#125;&quot;</span>, image.nx, image.ny, image.nz);</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;There are a total of &#123;&#125; voxels&quot;</span>, image.nvox)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;Failed to read NIFTI image.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now we can run the program by running the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo run</span><br></pre></td></tr></table></figure>

<p>If everything is set up correctly, you should see the output of the program, which will display the dimensions of the NIfTI image. If you encounter any errors, make sure the paths are correctly set in the <code>build.rs</code> file and the <code>nifti_io.rs</code> file. Also, make sure the C library files are in the correct directory. </p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This tutorail quickly goes through the process of using the NIfTI C library in Rust. We created a Rust project, compiled the C library, created Rust structs to mirror the C structs, and implemented the read function in Rust. We then tested the read function in the <code>main.rs</code> file. There are more thing to consider when working with C library in Rust, such as better error handling, generic type for data field in the NIfTI image struct, and more functions to implement. But this tutorial should give you a good starting point for working with the NIfTI C library in Rust. </p>

</div> 

<script>
    window.onload = detectors();
</script>
    <div class="post-footer">
    <div class="h-line-primary"></div>
    <nav class="post-nav">
        <div class="prev-item">
           
        </div>
        <div class="next-item">
            
                <div class="icon arrow-right"></div>
                <div class="post-link">
                  <a href="/2024/09/20/hello-world/">Next</a>  
                </div>  
            
        </div>
    </nav>
</div>

    
      <div class="post-comment">

     

     
    
    

</div>
     
  
</article>
        </div>
      </div>
      
      <div class="footer">
    <div class="flex-container">
        <div class="footer-text">
            
                Email: <a href='mailto:contact@singleneuron.com'>contact@singleneuron.com </a>
                <br>
            
            
                Single Neuron @ 2024
            
                
        </div>
    </div>
</div>

    </div>

    
      <div class="search-popup">
    <div class="search-popup-overlay">  
    </div>
    <div class="search-popup-window" >
        <div class="search-header">
            <div class="search-input-container">
              <input autocomplete="off" autocapitalize="off" maxlength="80"
                     placeholder="Search Anything" spellcheck="false"
                     type="search" class="search-input">
            </div>
            <div class="search-close-btn">
                <div class="icon close-btn"></div>
            </div>
        </div>
        <div class="search-result-container">
        </div>
    </div>
</div>

<script>
    const searchConfig = {
        path             : "/search.xml",
        top_n_per_article: "1",
        unescape         : "false",
        trigger: "auto",
        preload: "false"
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/hexo-generator-searchdb@1.4.0/dist/search.js"></script>
<script src="/js/search.js"></script>
    
    

  </body>
</html>
